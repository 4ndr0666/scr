#!/bin/sh
#
# chunkify-500
# Split video into ~500MB segments (or specified size).
# Usage: chunkify-500 <input-file> [max-size-MB]
#

usage() {
    cat <<EOF
chunkify-500: Split large video files into chunks by size.

Usage:
  $0 <input-file> [max-size-MB]
Options:
  -h, --help     Show this help message

Arguments:
  <input-file>   Video file to split
  [max-size-MB]  Maximum size per part in megabytes (default: 500)

Examples:
  $0 movie.mp4
  $0 bigvideo.mkv 250

This script will create parts named:
  movie_part001.mp4, movie_part002.mp4, ...
EOF
}

# Help
case "$1" in
  -h|--help) usage; exit 0;;
esac

if [ $# -lt 1 ]; then
    echo "Error: No input file specified." >&2
    usage
    exit 1
fi

IN="$1"
if [ ! -f "$IN" ]; then
    echo "Error: '$IN' not found." >&2
    exit 2
fi

MAX_MB=${2:-500}
MAX_BYTES=$((MAX_MB * 1024 * 1024))
BASE="${IN%.*}"
EXT="${IN##*.}"

# Get duration in seconds (ffprobe)
DUR=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$IN" 2>/dev/null)
if [ -z "$DUR" ]; then
    echo "Error retrieving duration." >&2
    exit 3
fi

echo "Splitting '$IN' into parts of ~${MAX_MB}MB..."

START=0
IDX=1

while [ "$(printf "%.0f" "$START")" -lt "$(printf "%.0f" "$DUR")" ]; do
    PART=$(printf "%s_part%03d.%s" "$BASE" "$IDX" "$EXT")
    echo "Creating part #$IDX: $PART"

    # Attempt split; if fails, reduces size by 10% and retries
    ATTEMPTS=0
    SIZE_OK=1
    while [ $ATTEMPTS -lt 3 ]; do
        ffmpeg -nostats -hide_banner -ss "$START" -i "$IN" -c copy -fs "$MAX_BYTES" "$PART"
        if [ $? -eq 0 ]; then
            SIZE_OK=0
            break
        fi
        ATTEMPTS=$((ATTEMPTS+1))
        MAX_BYTES=$((MAX_BYTES * 9 / 10))
        echo "Retry $ATTEMPTS with smaller target size ($MAX_BYTES bytes)..."
    done

    if [ $SIZE_OK -ne 0 ]; then
        echo "Warning: Could not produce part #$IDX under target size." >&2
    fi

    # Report size
    BYTES=$(stat -c%s "$PART")
    echo "  â†’ Created: $PART ($(printf "%.2f" "$(echo "$BYTES/1024/1024" | bc -l)") MB)"

    # Advance start by approximate duration of last part
    SEEN_DUR=$(ffprobe -v error -show_entries format=duration \
      -of default=noprint_wrappers=1:nokey=1 "$PART")
    START=$(echo "$START + $SEEN_DUR" | bc)
    IDX=$((IDX+1))
done

echo "Splitting complete."
