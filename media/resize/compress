#!/bin/sh
#
# compression
# Compress a video file with lossy encoding (default CRF=24).
# Usage: compression <input-file> [output-file] [crf]
#

usage() {
    cat <<EOF
compression: Lossy video compression script using ffmpeg.

Usage:
  $0 <input-file> [output-file] [crf-value]

Options:
  -h, --help     Show this help message

Arguments:
  <input-file>   Source video file
  [output-file]  Output file (default: <input>-compressed.mp4)
  [crf-value]    CRF quality factor (lower=better quality, default: 24)

Example:
  $0 movie.mp4
  $0 bigclip.mkv smallclip.mp4 28

This script reports progress and file sizes.
EOF
}

# Help
case "$1" in
  -h|--help) usage; exit 0;;
esac

if [ $# -lt 1 ]; then
    echo "Error: Input file is required." >&2
    usage
    exit 1
fi

IN="$1"
if [ ! -f "$IN" ]; then
    echo "Error: '$IN' not found." >&2
    exit 2
fi

OUT="${2:-${IN%.*}-compressed.mp4}"
CRF="${3:-24}"

echo "Original size: $(du -h "$IN" | cut -f1)"

echo "Compressing with CRF=$CRF..."
ffmpeg -hide_banner -y -i "$IN" \
  -c:v libx264 -preset medium -crf "$CRF" \
  -c:a aac -b:a 128k "$OUT"
RC=$?

if [ $RC -ne 0 ]; then
    echo "Primary compression failed; retrying with slower preset for better stability..."
    ffmpeg -hide_banner -y -i "$IN" \
      -c:v libx264 -preset slow -crf "$CRF" \
      -c:a aac -b:a 128k "$OUT"
fi

echo "Final size: $(du -h "$OUT" | cut -f1)"
echo "Compression complete. Saved as '$OUT'."
