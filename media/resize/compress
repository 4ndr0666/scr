#!/bin/sh
# compression: Lossy video compressor for adversarial OS workflows
# 4ndr0666OS v3.0.0

set -eu

IN=""
OUT=""
CRF=24
PRESET="slow"
RETRY=3

print_help() {
  cat <<EOF
compression: Efficient, lossy compression of video files.

USAGE:
  $0 [OPTIONS] input_file [output_file]

OPTIONS:
  -c CRF       Set CRF (quality: 18–30, default: 24)
  -p PRESET    ffmpeg preset (ultrafast...veryslow, default: slow)
  -h, --help   Show this help and exit

EXAMPLES:
  $0 video.mp4 compressed.mp4
  $0 -c 22 -p medium video.mp4

ENV:
  Requires: ffmpeg, ffprobe

NOTES:
- Lower CRF = higher quality/larger size. Try 18–28.
- Output will always overwrite if exists.
EOF
}

human_size() {
  awk '{
    split("B KB MB GB TB PB", units);
    s = $1;
    for (i = 1; s >= 1024 && i < 6; i++) s /= 1024;
    printf "%.2f %s\n", s, units[i]
  }'
}

fail() { echo "ERROR: $*" >&2; exit 1; }

# Parse args
while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help) print_help; exit 0 ;;
    -c) shift; CRF="$1"; shift ;;
    -p) shift; PRESET="$1"; shift ;;
    -*) fail "Unknown flag: $1";;
    *) [ -z "$IN" ] && IN="$1" || ([ -z "$OUT" ] && OUT="$1" || fail "Too many positional arguments"); shift ;;
  esac
done

[ -z "$IN" ] && { print_help; exit 1; }
[ ! -f "$IN" ] && fail "Input file not found: $IN"
[ -z "$OUT" ] && OUT="compressed_${IN##*/}"

IN_SIZE=$(stat -c%s "$IN")
echo "Compressing '$IN' ($(echo "$IN_SIZE" | human_size)) → $OUT [crf=$CRF, preset=$PRESET]"

do_compress() {
  ffmpeg -y -v error -i "$IN" \
    -c:v libx264 -preset "$PRESET" -crf "$CRF" \
    -c:a aac -b:a 128k "$OUT"
}

for attempt in $(seq 1 $RETRY); do
  do_compress && break
  echo "Retry $attempt/$RETRY for compression"
  sleep 1
  [ "$attempt" -eq "$RETRY" ] && fail "Compression failed after $RETRY attempts."
done

OUT_SIZE=$(stat -c%s "$OUT")
echo "Compression complete: $(echo "$OUT_SIZE" | human_size) → $OUT"

exit 0
