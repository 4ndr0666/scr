# Makefile for the mem-police project

CC         := cc
CFLAGS     := -O2 -std=c11 -Wall -Wextra -pedantic -D_POSIX_C_SOURCE=200809L
LDFLAGS    := -lpcre2-8
TARGET     := mem-police
INSTALLDIR := /usr/local/sbin
TESTER     := mem-police-tester.sh

.PHONY: all build install uninstall test lint clean help

all: build

build: $(TARGET) # Compile the C daemon
	@echo "üèóÔ∏è  Building $(TARGET)..."
	@$(CC) $(CFLAGS) -o $(TARGET) $(TARGET).c $(LDFLAGS)
	@echo "‚úÖ Build complete!"

install: build # Install the daemon and test script
	@echo "üì¶ Installing $(TARGET) to $(INSTALLDIR)..."
	@sudo cp -f $(TARGET) $(INSTALLDIR)/
	@echo "üì¶ Installing $(TESTER) to $(INSTALL-DIR)..."
	@sudo cp -f $(TESTER) $(INSTALLDIR)/
	@echo "‚úÖ Installation complete!"

uninstall: # Remove the installed files
	@echo "üóëÔ∏è  Removing $(INSTALLDIR)/$(TARGET)..."
	@sudo rm -f $(INSTALLDIR)/$(TARGET)
	@echo "üóëÔ∏è  Removing $(INSTALLDIR)/$(TESTER)..."
	@sudo rm -f $(INSTALLDIR)/$(TESTER)
	@echo "‚úÖ Uninstallation complete!"

test: # Run the integration test script
	@echo "üß™ Running integration test suite..."
	@if ! pgrep -x $(TARGET) >/dev/null 2>&1; then \
		echo "   -> Error: '$(TARGET)' daemon is not running. Please start it as root."; \
		exit 1; \
	fi
	@sudo ./${TESTER}

lint: # Run shellcheck on the test script
	@echo "üîç Running shellcheck on the test script..."
	@shellcheck $(TESTER)

clean: # Remove the compiled binary
	@echo "üßπ Cleaning up build artifacts..."
	@rm -f $(TARGET)
	@echo "‚úÖ Cleaned."

help: # Show this help message
	@echo "mem-police Project Makefile"
	@echo "==========================="
	@echo "make build        Compile the $(TARGET) daemon"
	@echo "make install      Compile and install the daemon and tester"
	@echo "make uninstall    Remove installed files"
	@echo "make test         Run the integration test suite"
	@echo "make lint         Run shellcheck on the test script"
	@echo "make clean        Remove the compiled binary"
	@echo "make help         Show this help"